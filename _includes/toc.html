{% comment %}
Table of Contents (TOC) include file
Usage: {% include toc.html html=content h_min=2 h_max=4 %}
{% endcomment %}

{% assign html = include.html | strip_newlines %}

{% comment %} Find H2, H3, H4 headers {% endcomment %}
{% if include.h_min and include.h_max %}
  {% assign min_level = include.h_min | default: 2 %}
  {% assign max_level = include.h_max | default: 4 %}
{% else %}
  {% assign min_level = 2 %}
  {% assign max_level = 4 %}
{% endif %}

{% assign headers = "" | split: "" %}
{% for line in html %}
  {% assign line_stripped = line | strip %}
  {% assign header_match = line_stripped | regex_replace: "^\\s*<(h[1-6])[^>]*>(.*)</\\1>", "\\1|\\2" %}
  {% if header_match contains "|" %}
    {% assign level = header_match | slice: 0, 1 | plus: 0 %}
    {% assign title = header_match | split: "|" | last | strip_html | strip %}
    {% if level >= min_level and level <= max_level and title != "" %}
      {% assign id = title | slugify %}
      {% assign current = level | minus: min_level %}
      {% assign headers = headers | push: level | join: "|" %}
      {% assign headers = headers | push: title | join: "|" %}
      {% assign headers = headers | push: id | join: "|" %}
      {% assign headers = headers | split: "|" %}
    {% endif %}
  {% endif %}
{% endfor %}

{% if headers.size > 0 %}
<nav class="table-of-contents" aria-label="Table of Contents">
  <h3 class="toc-title">Table of Contents</h3>
  <ul class="toc-list" role="list">
    {% assign prev_level = min_level %}
    {% for i in (0..headers.size) step: 3 %}
      {% assign level = headers[i] | plus: 0 %}
      {% assign title = headers[i | plus: 1] %}
      {% assign id = headers[i | plus: 2] %}
      
      {% if level > 0 and title != "" and id != "" %}
        {% assign level_diff = level | minus: prev_level %}
        
        {% if level_diff > 1 %}
          {% for j in (1..level_diff) %}
            <li class="toc-item toc-nested-start">
              <ul class="toc-sublist">
          {% endfor %}
        {% elsif level_diff < 1 and prev_level > level %}
          {% for j in (1..level_diff | abs) %}
              </ul>
            </li>
          {% endfor %}
        {% endif %}
        
        <li class="toc-item">
          <a href="#{{ id }}" class="toc-link" title="{{ title }}">
            {{ title }}
          </a>
        </li>
        
        {% assign prev_level = level %}
      {% endif %}
    {% endfor %}
    
    {% if prev_level > min_level %}
      {% for j in (1..prev_level | minus: min_level) %}
        </ul>
      </li>
      {% endfor %}
    {% endif %}
  </ul>
</nav>
{% endif %}
