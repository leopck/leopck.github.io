
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Getting ESP32 to 12µA Sleep Current - Fridays with Faraday</title>
  <meta name="description" content="**Tags:** ESP32 • Low Power • Deep Sleep">
  <link rel="stylesheet" href="../css/style.css">
  <link rel="alternate" type="application/rss+xml" title="Fridays with Faraday" href="../rss.xml">
</head>
<body>
  <div class="background"></div>
  <div class="grid-overlay"></div>

  
<nav>
  <div class="container">
    <a href="/" class="logo">
      <span class="logo-f">f</span><span class="logo-slash">/</span><span class="logo-f">f</span>
    </a>
    <ul class="nav-menu">
      <li><a href="/#work">Work</a></li>
      <li><a href="/experiments.html" class="active">Experiments</a></li>
      <li><a href="/search.html">Search</a></li>
      <li><a href="mailto:your.email@example.com">Contact</a></li>
    </ul>
    <button class="nav-toggle" aria-label="Toggle menu">
      <span></span>
      <span></span>
      <span></span>
    </button>
  </div>
</nav>

  
<section class="experiment-header">
  <div class="container">
    <h1 class="experiment-title">Getting ESP32 to 12µA Sleep Current</h1>
    <div class="experiment-meta">
      <span class="tag">experiments</span>
      
      <span class="tag difficulty-intermediate">intermediate</span>
    </div>
    <div class="post-meta">
      <span class="meta-item">
        <strong>Date:</strong> 11/2/2025
      </span>
      <span class="meta-item">
        <strong>Read Time:</strong> undefined
      </span>
      <span class="meta-item">
        <strong>Author:</strong> 
      </span>
    </div>
    <p class="post-description">**Tags:** ESP32 • Low Power • Deep Sleep</p>
  </div>
</section>

<section>
  <div class="container">
    <div class="content-layout">
      <main class="content-main">
        
    <div class="toc">
      <h3>Table of Contents</h3>
      <nav class="toc-nav">
        <a href="#getting-esp32-to-12a-sleep-current" class="toc-link toc-level-1">
            Getting ESP32 to 12µA Sleep Current
          </a>
        <a href="#results" class="toc-link toc-level-2">
              Results
          </a>
        <a href="#the-problem" class="toc-link toc-level-2">
              The Problem
          </a>
        <a href="#baseline-measurement" class="toc-link toc-level-2">
              Baseline Measurement
          </a>
        <a href="#optimization-steps" class="toc-link toc-level-2">
              Optimization Steps
          </a>
        <a href="#1-disable-wifi-and-bluetooth" class="toc-link toc-level-3">
                1. Disable WiFi and Bluetooth
          </a>
        <a href="#2-configure-gpio-states" class="toc-link toc-level-3">
                2. Configure GPIO States
          </a>
        <a href="#3-power-domain-configuration" class="toc-link toc-level-3">
                3. Power Domain Configuration
          </a>
        <a href="#4-disable-internal-regulators" class="toc-link toc-level-3">
                4. Disable Internal Regulators
          </a>
        <a href="#5-external-component-check" class="toc-link toc-level-3">
                5. External Component Check
          </a>
        <a href="#final-implementation" class="toc-link toc-level-2">
              Final Implementation
          </a>
        <a href="#results" class="toc-link toc-level-2">
              Results
          </a>
        <a href="#lessons-learned" class="toc-link toc-level-2">
              Lessons Learned
          </a>
      </nav>
    </div>
  
        <div class="post-content">
          <p><h1 id="getting-esp32-to-12a-sleep-current">Getting ESP32 to 12µA Sleep Current</h1></p><p><strong>Tags:</strong> ESP32 • Low Power • Deep Sleep</p><p>Out of the box, ESP32 deep sleep pulls around 150µA. This documents how I got it down to 12µA by tweaking power domains, disabling peripherals, and configuring GPIO properly.</p><p><h2 id="results">Results</h2></p><p><tr><td>Metric</td><td>Value</td></tr>
<tr><td>--------</td><td>--------</td></tr>
<tr><td><strong>Sleep Current</strong></td><td>12µA</td></tr>
<tr><td><strong>Wake Time</strong></td><td>800ms</td></tr>
<tr><td><strong>Power Reduction</strong></td><td>92%</td></tr>
<tr><td><strong>CR2032 Battery Life</strong></td><td>3 Years</td></tr></p><p><h2 id="the-problem">The Problem</h2></p><p>I needed to run a sensor node on a coin cell for years. ESP32 is great for quick prototyping with WiFi, but the default deep sleep current of 150µA means a CR2032 battery (220mAh) would only last about 2 months. Not good enough.</p><p>The datasheet claims 10µA is possible in deep sleep, so I set out to figure out what was consuming all that extra power.</p><p><h2 id="baseline-measurement">Baseline Measurement</h2></p><p>First, I needed to know where I was starting from. Using a µCurrent Gold in series with the power supply:</p><p>
<div class="terminal">
  <div class="terminal-header">
    <div class="terminal-dot" style="background: #ff5f56;"></div>
    <div class="terminal-dot" style="background: #ffbd2e;"></div>
    <div class="terminal-dot" style="background: #27c93f;"></div>
  </div>
  <div class="terminal-content">
    <pre><code>$ measure_current.py --mode deep_sleep
Entering deep sleep...
Average current: 147.3 µA
Peak current: 152.1 µA
⚠ Target: 10-15 µA (10x higher than expected!)</code></pre>
  </div>
</div></p><p><div class="code-block"><pre><code class="language-c">// Initial naive deep sleep code
void enter_deep_sleep() {
    esp_sleep_enable_timer_wakeup(60 * 1000000); // 60 seconds
    esp_deep_sleep_start();
}</code></pre></div></p><p><h2 id="optimization-steps">Optimization Steps</h2></p><p><h3 id="1-disable-wifi-and-bluetooth">1. Disable WiFi and Bluetooth</h3></p><p>Even though they're not actively used, the radios can leak current.</p><p><div class="code-block"><pre><code class="language-c">void disable_radios() {
    esp_wifi_stop();
    esp_bt_controller_disable();
    // Result: 147µA → 138µA (9µA saved)
}</code></pre></div></p><p><h3 id="2-configure-gpio-states">2. Configure GPIO States</h3></p><p>This was the big one. Floating GPIO pins can cause significant current draw. Each pin needs to be explicitly configured.</p><p><div class="code-block"><pre><code class="language-c">void configure_gpio_for_sleep() {
    // Disable all GPIO pull-ups/pull-downs except RTC pins
    for (int i = 0; i &lt; GPIO_NUM_MAX; i++) {
        if (!rtc_gpio_is_valid_gpio(i)) {
            gpio_reset_pin(i);
            gpio_set_direction(i, GPIO_MODE_INPUT);
            gpio_set_pull_mode(i, GPIO_FLOATING);
        }
    }
    
    // Configure RTC GPIO for wake-up if needed
    rtc_gpio_pullup_en(GPIO_NUM_33);
    rtc_gpio_pulldown_dis(GPIO_NUM_33);
    
    // Result: 138µA → 45µA (93µA saved!)
}</code></pre></div></p><p><h3 id="3-power-domain-configuration">3. Power Domain Configuration</h3></p><p>ESP32 has multiple power domains. Shutting down unused ones helps significantly.</p><p><div class="code-block"><pre><code class="language-c">void configure_power_domains() {
    // Keep only RTC_SLOW_MEM powered in deep sleep
    esp_sleep_pd_config(ESP_PD_DOMAIN_RTC_PERIPH, ESP_PD_OPTION_OFF);
    esp_sleep_pd_config(ESP_PD_DOMAIN_RTC_SLOW_MEM, ESP_PD_OPTION_ON);
    esp_sleep_pd_config(ESP_PD_DOMAIN_RTC_FAST_MEM, ESP_PD_OPTION_OFF);
    esp_sleep_pd_config(ESP_PD_DOMAIN_XTAL, ESP_PD_OPTION_OFF);
    
    // Result: 45µA → 28µA (17µA saved)
}</code></pre></div></p><p><h3 id="4-disable-internal-regulators">4. Disable Internal Regulators</h3></p><p>Some internal voltage regulators can be disabled if using external power supply regulation.</p><p><div class="code-block"><pre><code class="language-c">// Reduce internal regulator current in deep sleep
esp_sleep_pd_config(ESP_PD_DOMAIN_RTC_PERIPH, ESP_PD_OPTION_OFF);</p><p>// Use external 3.3V regulator, disable internal LDO
REG_CLR_BIT(RTC_CNTL_REG, RTC_CNTL_REGULATOR_FORCE_PU);</p><p>// Result: 28µA → 15µA (13µA saved)</code></pre></div></p><p><h3 id="5-external-component-check">5. External Component Check</h3></p><p>Don't forget about external components! The devboard had a power LED that drew 3µA.</p><p><div class="code-block"><pre><code class="language-c">// Physical modification: remove power LED
// Also verified no pull-ups on I2C lines (they were adding 2µA each)</p><p>// Result: 15µA → 12µA (3µA saved)</code></pre></div></p><p><h2 id="final-implementation">Final Implementation</h2></p><p>Here's the complete optimized sleep function:</p><p><div class="code-block"><pre><code class="language-c">#include &quot;esp_sleep.h&quot;
#include &quot;driver/rtc_io.h&quot;</p><p>void enter_ultra_low_power_sleep(uint64_t sleep_time_us) {
    // 1. Disable radios
    esp_wifi_stop();
    esp_bt_controller_disable();
    
    // 2. Configure all GPIO
    for (int i = 0; i &lt; GPIO_NUM_MAX; i++) {
        if (!rtc_gpio_is_valid_gpio(i)) {
            gpio_reset_pin(i);
            gpio_set_direction(i, GPIO_MODE_INPUT);
            gpio_set_pull_mode(i, GPIO_FLOATING);
        }
    }
    
    // 3. Configure power domains
    esp_sleep_pd_config(ESP_PD_DOMAIN_RTC_PERIPH, ESP_PD_OPTION_OFF);
    esp_sleep_pd_config(ESP_PD_DOMAIN_RTC_SLOW_MEM, ESP_PD_OPTION_ON);
    esp_sleep_pd_config(ESP_PD_DOMAIN_RTC_FAST_MEM, ESP_PD_OPTION_OFF);
    esp_sleep_pd_config(ESP_PD_DOMAIN_XTAL, ESP_PD_OPTION_OFF);
    
    // 4. Disable unnecessary regulators
    REG_CLR_BIT(RTC_CNTL_REG, RTC_CNTL_REGULATOR_FORCE_PU);
    
    // 5. Set wake time and sleep
    esp_sleep_enable_timer_wakeup(sleep_time_us);
    esp_deep_sleep_start();
}</code></pre></div></p><p><h2 id="results">Results</h2></p><p>Final measurement with the optimized code:</p><p>
<div class="terminal">
  <div class="terminal-header">
    <div class="terminal-dot" style="background: #ff5f56;"></div>
    <div class="terminal-dot" style="background: #ffbd2e;"></div>
    <div class="terminal-dot" style="background: #27c93f;"></div>
  </div>
  <div class="terminal-content">
    <pre><code>$ measure_current.py --mode deep_sleep
Entering deep sleep...
Average current: 12.1 µA
Peak current: 13.4 µA
✓ Target achieved! 92% reduction from baseline</p><p>$ calculate_battery_life --capacity 220 --current 12.1
Estimated battery life: 2.08 years (CR2032)</code></pre>
  </div>
</div></p><p><h2 id="lessons-learned">Lessons Learned</h2></p><p>• <strong>GPIO configuration was the biggest win (93µA saved).</strong> Always configure every pin explicitly.  
• Don't trust devboards for power measurements - they have extra components that consume power.  
• The datasheet is optimistic but achievable with proper configuration.  
• Use an actual current meter, not just multimeter - you need µA resolution.  
• Document your baseline before optimizing - you need to know what you're improving from.</p><p>---</p><p><em><a href="../experiments.html">← Back to all experiments</a></em></p>
        </div>
        
    <div class="related-posts">
      <h3>Related Posts</h3>
      <div class="related-grid">
        
          <a href="../experiments/bootloader.html" class="related-card">
            <h4>Minimal Bare Metal Bootloader</h4>
            <p>**ARM Cortex-M4** • **Bootloader** • **Assembly**</p>
            <span class="tag">experiments</span>
          </a>
        
          <a href="../experiments/stm32-dma.html" class="related-card">
            <h4>High-Speed ADC with DMA</h4>
            <p>**STM32F4** **DMA** **ADC**</p>
            <span class="tag">experiments</span>
          </a>
        
          <a href="../experiments/esp32-adc-performance.html" class="related-card">
            <h4>ESP32 High-Speed ADC Performance: DMA and Interrupt Analysis</h4>
            <p>High-speed analog-to-digital conversion on microcontrollers often becomes CPU-bound long before hitting the advertised sampling rates. The ESP32 integrates two successive approximation register (SAR) </p>
            <span class="tag">experiments</span>
          </a>
        
      </div>
    </div>
  
      </main>
    </div>
  </div>
</section>

  <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border);">
    <div class="container">
      <a href="../experiments.html" style="color: var(--accent); text-decoration: none;">← Back to all experiments</a>
    </div>
  </div>

  
<footer>
  <div class="container">
    <div class="footer-content">
      <div class="footer-logo">
        <span class="logo-f">f</span><span class="logo-slash">/</span><span class="logo-f">f</span>
      </div>
      <p>Fridays with Faraday - Working with microcontrollers and embedded systems</p>
      <div class="footer-links">
        <a href="/rss.xml">RSS Feed</a>
        <a href="https://github.com/yourusername/yourusername.github.io">GitHub</a>
      </div>
    </div>
  </div>
</footer>

  <script src="../js/main.js"></script>
</body>
</html>