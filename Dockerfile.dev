# Development Dockerfile for Fridays with Faraday Jekyll site
FROM ruby:3.3-slim

# Set working directory
WORKDIR /app

# Install system dependencies for Jekyll and development
RUN apt-get update && apt-get install -y \
    build-essential \
    git \
    curl \
    vim \
    less \
    tree \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js for any JavaScript tooling
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - && \
    apt-get install -y nodejs

# Install yarn
RUN npm install -g yarn

# Install bundler and specific versions to avoid conflicts
RUN gem install bundler:2.4.22 --no-document && \
    gem install jekyll --no-document

# Copy gemfile and install dependencies
COPY Gemfile ./

# Install Jekyll and all dependencies with specific flags to bypass circular dependency checks
RUN bundle config set --local path "vendor/bundle" && \
    bundle install --jobs 4 --retry 3 --local || \
    bundle install --jobs 4 --retry 3 --ignore-dependencies || \
    bundle install --jobs 4 --retry 3 --force

# Copy source code
COPY . .

# Create necessary directories
RUN mkdir -p _site .jekyll-cache

# Set environment variables
ENV JEKYLL_ENV=development
ENV BUNDLE_GEMFILE=/app/Gemfile

# Expose development server port
EXPOSE 4000

# Default command for development
CMD ["bundle", "exec", "jekyll", "serve", "--host", "0.0.0.0", "--port", "4000", "--livereload", "--drafts"]
