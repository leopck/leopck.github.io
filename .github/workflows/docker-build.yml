name: Jekyll Site with Docker Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Load Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        push: false
        tags: fridays-with-faraday:latest
        outputs: type=docker,dest=/tmp/jekyll-image.tar
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Import Docker image
      run: docker load --input /tmp/jekyll-image.tar

    - name: Setup Pages
      if: github.event_name != 'pull_request'
      uses: actions/configure-pages@v4

    - name: Build site with Docker
      run: |
        echo "ğŸ—ï¸ Building Jekyll site with Docker..."
        docker run --rm \
          --volume="${{ github.workspace }}:/srv/jekyll" \
          --volume="${{ github.workspace }}_site:/srv/jekyll/_site" \
          fridays-with-faraday \
          jekyll build --baseurl "/${{ github.event.repository.name }}" --destination /srv/jekyll/_site

    - name: Upload Pages artifact
      if: github.event_name != 'pull_request'
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site

    - name: Verify build
      run: |
        echo "âœ… Docker build completed!"
        echo "ğŸ“ Generated files:"
        find _site -type f | wc -l
        echo "files created"
        echo "ğŸ” Site structure:"
        ls -la _site/
        echo "ğŸ” Sample posts generated:"
        find _site -name "*.html" | grep -E "(esp32|experiments)" | head -5

  deploy:
    if: github.event_name != 'pull_request' && ((github.ref == 'refs/heads/main') || (github.ref == 'refs/heads/master'))
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  test-docker-build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Test Docker build locally
      run: |
        echo "ğŸ³ Testing Docker build process..."
        docker build -t fridays-with-faraday-test .
        
        echo "ğŸ—ï¸ Running Docker build test..."
        docker run --rm \
          --volume="${{ github.workspace }}:/srv/jekyll" \
          --volume="${{ github.workspace }}_site:/srv/jekyll/_site" \
          fridays-with-faraday-test \
          jekyll build --destination /srv/jekyll/_site
        
        echo "âœ… Docker build test passed!"
        
        echo "ğŸ” Testing Docker output:"
        ls -la _site/
        test -f _site/index.html && echo "âœ… index.html generated"
        test -f _site/rss.xml && echo "âœ… rss.xml generated"
        test -f _site/sitemap.xml && echo "âœ… sitemap.xml generated"