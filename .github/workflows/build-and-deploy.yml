name: Jekyll Site CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for proper Jekyll site generation

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
        cache-version: 1 # Increment this to force cache invalidation

    - name: Install dependencies
      run: |
        gem install bundler
        bundle install --jobs 4 --retry 3

    - name: Setup Pages
      if: github.event_name != 'pull_request'
      uses: actions/configure-pages@v4

    - name: Build Jekyll site
      run: |
        bundle exec jekyll build --baseurl "/${{ github.event.repository.name }}" --destination _site
      env:
        JEKYLL_ENV: production
        LC_ALL: C.UTF-8
        LANG: C.UTF-8

    - name: Upload Pages artifact
      if: github.event_name != 'pull_request'
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site

    - name: Verify build output
      run: |
        echo "âœ… Jekyll build completed successfully!"
        echo "ðŸ“ Generated files:"
        find _site -type f | wc -l
        echo "files created"
        echo "ðŸ” Key files generated:"
        ls -la _site/ | head -10

  deploy:
    if: github.event_name != 'pull_request' && ((github.ref == 'refs/heads/main') || (github.ref == 'refs/heads/master'))
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
        cache-version: 1

    - name: Install dependencies
      run: bundle install --jobs 4 --retry 3

    - name: Lint Jekyll configuration
      run: |
        echo "ðŸ” Checking Jekyll configuration..."
        bundle exec jekyll doctor --url / || echo "âš ï¸ Configuration warnings found"

    - name: Validate links
      run: |
        echo "ðŸ”— Validating internal links..."
        bundle exec jekyll build --quiet 2>&1 | grep -i "warning\|error" || echo "âœ… No link issues found"

    - name: Check for orphaned files
      run: |
        echo "ðŸ“‹ Checking for orphaned files..."
        find _posts -name "*.md" -exec basename {} \; | sort > /tmp/posts.txt
        find _site -name "*.html" -exec basename {} \; | grep -v "index.html" | sort > /tmp/generated.txt
        echo "Posts: $(wc -l < /tmp/posts.txt)"
        echo "Generated pages: $(wc -l < /tmp/generated.txt)"