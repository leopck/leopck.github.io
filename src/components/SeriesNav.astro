---
import { getCollection } from 'astro:content';

interface Props {
  series: string;
  currentOrder: number;
}

const { series, currentOrder } = Astro.props;

const allPosts = await getCollection('posts', ({ data }) => 
  !data.draft && data.series === series
);

const sortedPosts = allPosts.sort((a, b) => 
  (a.data.seriesOrder || 0) - (b.data.seriesOrder || 0)
);

const currentIndex = sortedPosts.findIndex((p) => p.data.seriesOrder === currentOrder);
const prevPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;
const nextPost = currentIndex < sortedPosts.length - 1 ? sortedPosts[currentIndex + 1] : null;
---

<div class="series-nav">
  <div class="series-header">
    <span class="series-label">Part of Series</span>
    <span class="series-name">{series}</span>
    <span class="series-progress">
      {currentOrder} of {sortedPosts.length}
    </span>
  </div>
  
  <div class="series-parts">
    {sortedPosts.map((post, index) => (
      <a 
        href={`/posts/${post.slug}`}
        class:list={[
          'series-part',
          { 
            'current': post.data.seriesOrder === currentOrder,
            'completed': (post.data.seriesOrder || 0) < currentOrder
          }
        ]}
        aria-current={post.data.seriesOrder === currentOrder ? 'page' : undefined}
      >
        <span class="part-number">{index + 1}</span>
        <span class="part-title">{post.data.title}</span>
      </a>
    ))}
  </div>
  
  <div class="series-navigation">
    {prevPost ? (
      <a href={`/posts/${prevPost.slug}`} class="nav-btn prev">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        <span>Previous: {prevPost.data.title}</span>
      </a>
    ) : (
      <div></div>
    )}
    
    {nextPost ? (
      <a href={`/posts/${nextPost.slug}`} class="nav-btn next">
        <span>Next: {nextPost.data.title}</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </a>
    ) : (
      <div></div>
    )}
  </div>
</div>

<style lang="scss">
  @use '../styles/variables' as *;
  
  .series-nav {
    margin-bottom: $space-8;
    padding: $space-5;
    background: $color-bg-secondary;
    border: 1px solid $color-border-default;
    border-radius: $border-radius-lg;
  }
  
  .series-header {
    display: flex;
    align-items: center;
    gap: $space-3;
    margin-bottom: $space-4;
    padding-bottom: $space-4;
    border-bottom: 1px solid $color-border-default;
  }
  
  .series-label {
    font-size: $font-size-xs;
    font-family: $font-mono;
    text-transform: uppercase;
    letter-spacing: $letter-spacing-wider;
    color: $color-text-tertiary;
  }
  
  .series-name {
    font-family: $font-display;
    font-weight: $font-weight-semibold;
    color: $color-accent-blue;
    flex: 1;
  }
  
  .series-progress {
    font-size: $font-size-sm;
    font-family: $font-mono;
    color: $color-text-secondary;
    padding: $space-1 $space-2;
    background: $color-bg-tertiary;
    border-radius: $border-radius-sm;
  }
  
  .series-parts {
    display: flex;
    flex-direction: column;
    gap: $space-2;
    margin-bottom: $space-4;
  }
  
  .series-part {
    display: flex;
    align-items: center;
    gap: $space-3;
    padding: $space-2 $space-3;
    text-decoration: none;
    border-radius: $border-radius-md;
    transition: all $transition-fast;
    
    &:hover {
      background: $color-bg-tertiary;
      text-decoration: none;
    }
    
    &.current {
      background: rgba($color-accent-blue, 0.1);
      
      .part-number {
        background: $color-accent-blue;
        color: $color-bg-primary;
      }
      
      .part-title {
        color: $color-accent-blue;
        font-weight: $font-weight-medium;
      }
    }
    
    &.completed {
      .part-number {
        background: $color-accent-green;
        color: $color-bg-primary;
        
        &::after {
          content: 'âœ“';
          font-size: 0.7em;
        }
      }
    }
  }
  
  .part-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    font-size: $font-size-xs;
    font-family: $font-mono;
    font-weight: $font-weight-semibold;
    background: $color-bg-tertiary;
    color: $color-text-secondary;
    border-radius: $border-radius-full;
    flex-shrink: 0;
  }
  
  .part-title {
    font-size: $font-size-sm;
    color: $color-text-secondary;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .series-navigation {
    display: flex;
    justify-content: space-between;
    gap: $space-4;
    padding-top: $space-4;
    border-top: 1px solid $color-border-default;
  }
  
  .nav-btn {
    display: flex;
    align-items: center;
    gap: $space-2;
    padding: $space-2 $space-3;
    font-size: $font-size-sm;
    color: $color-text-secondary;
    text-decoration: none;
    border-radius: $border-radius-md;
    background: $color-bg-tertiary;
    transition: all $transition-fast;
    max-width: 45%;
    
    &:hover {
      color: $color-text-primary;
      background: $color-bg-elevated;
      text-decoration: none;
    }
    
    span {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    &.next {
      margin-left: auto;
    }
  }
</style>
