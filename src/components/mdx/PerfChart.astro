---
/**
 * PerfChart Component
 * 
 * Renders performance comparison bar charts.
 * 
 * Usage in MDX:
 * <PerfChart
 *   title="Token Generation Throughput"
 *   unit="tokens/sec"
 *   data={[
 *     { label: "Baseline", value: 1200, color: "gray" },
 *     { label: "Optimized", value: 2400, color: "green" },
 *     { label: "With CUDA Graphs", value: 3100, color: "blue" },
 *   ]}
 * />
 */

interface DataPoint {
  label: string;
  value: number;
  color?: 'blue' | 'green' | 'orange' | 'red' | 'purple' | 'gray' | 'cyan';
  annotation?: string;
}

interface Props {
  title?: string;
  unit?: string;
  data: DataPoint[];
  showValues?: boolean;
  baseline?: number;
}

const { title, unit = '', data, showValues = true, baseline } = Astro.props;

const maxValue = Math.max(...data.map(d => d.value));
const baselineIndex = baseline !== undefined ? baseline : null;
---

<div class="perf-chart">
  {title && (
    <div class="chart-header">
      <h4 class="chart-title">{title}</h4>
      {unit && <span class="chart-unit">({unit})</span>}
    </div>
  )}
  
  <div class="chart-body">
    {data.map((item, index) => {
      const percentage = (item.value / maxValue) * 100;
      const improvement = baselineIndex !== null && index !== baselineIndex
        ? ((item.value - data[baselineIndex].value) / data[baselineIndex].value * 100).toFixed(1)
        : null;
      
      return (
        <div class="chart-row">
          <div class="row-label">
            <span class="label-text">{item.label}</span>
            {item.annotation && <span class="label-annotation">{item.annotation}</span>}
          </div>
          
          <div class="row-bar-container">
            <div 
              class:list={['row-bar', `color-${item.color || 'blue'}`]}
              style={`--width: ${percentage}%`}
            >
              {showValues && (
                <span class="bar-value">
                  {item.value.toLocaleString()}{unit && ` ${unit}`}
                </span>
              )}
            </div>
            
            {improvement && Number(improvement) > 0 && (
              <span class="improvement">+{improvement}%</span>
            )}
          </div>
        </div>
      );
    })}
  </div>
  
  {baselineIndex !== null && (
    <div class="chart-footer">
      <span class="baseline-note">
        ðŸ“Š Baseline: {data[baselineIndex].label}
      </span>
    </div>
  )}
</div>

<style lang="scss">
  @use '../../styles/variables' as *;
  
  .perf-chart {
    margin: $space-8 0;
    padding: $space-5;
    background: $color-bg-secondary;
    border: 1px solid $color-border-default;
    border-radius: $border-radius-lg;
  }
  
  .chart-header {
    display: flex;
    align-items: baseline;
    gap: $space-2;
    margin-bottom: $space-5;
    padding-bottom: $space-3;
    border-bottom: 1px solid $color-border-default;
  }
  
  .chart-title {
    font-family: $font-mono;
    font-size: $font-size-sm;
    font-weight: $font-weight-semibold;
    color: $color-text-primary;
    margin: 0;
  }
  
  .chart-unit {
    font-size: $font-size-xs;
    color: $color-text-tertiary;
  }
  
  .chart-body {
    display: flex;
    flex-direction: column;
    gap: $space-4;
  }
  
  .chart-row {
    display: grid;
    grid-template-columns: 140px 1fr;
    gap: $space-4;
    align-items: center;
    
    @media (max-width: 600px) {
      grid-template-columns: 1fr;
      gap: $space-2;
    }
  }
  
  .row-label {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  
  .label-text {
    font-family: $font-mono;
    font-size: $font-size-sm;
    color: $color-text-primary;
  }
  
  .label-annotation {
    font-size: $font-size-xs;
    color: $color-text-tertiary;
  }
  
  .row-bar-container {
    display: flex;
    align-items: center;
    gap: $space-3;
  }
  
  .row-bar {
    height: 32px;
    width: var(--width);
    min-width: 60px;
    border-radius: $border-radius-sm;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 0 $space-3;
    transition: width 0.5s ease-out;
    
    // Color variants
    &.color-blue {
      background: linear-gradient(90deg, rgba($color-accent-blue, 0.3), $color-accent-blue);
    }
    
    &.color-green {
      background: linear-gradient(90deg, rgba($color-accent-green, 0.3), $color-accent-green);
    }
    
    &.color-orange {
      background: linear-gradient(90deg, rgba($color-accent-orange, 0.3), $color-accent-orange);
    }
    
    &.color-red {
      background: linear-gradient(90deg, rgba($color-accent-red, 0.3), $color-accent-red);
    }
    
    &.color-purple {
      background: linear-gradient(90deg, rgba($color-accent-purple, 0.3), $color-accent-purple);
    }
    
    &.color-cyan {
      background: linear-gradient(90deg, rgba($color-accent-cyan, 0.3), $color-accent-cyan);
    }
    
    &.color-gray {
      background: linear-gradient(90deg, rgba($color-text-tertiary, 0.2), $color-text-tertiary);
    }
  }
  
  .bar-value {
    font-family: $font-mono;
    font-size: $font-size-xs;
    font-weight: $font-weight-semibold;
    color: $color-bg-primary;
    white-space: nowrap;
  }
  
  .improvement {
    font-family: $font-mono;
    font-size: $font-size-xs;
    font-weight: $font-weight-semibold;
    color: $color-accent-green;
    white-space: nowrap;
    padding: $space-1 $space-2;
    background: rgba($color-accent-green, 0.1);
    border-radius: $border-radius-sm;
  }
  
  .chart-footer {
    margin-top: $space-4;
    padding-top: $space-3;
    border-top: 1px solid $color-border-default;
  }
  
  .baseline-note {
    font-size: $font-size-xs;
    color: $color-text-tertiary;
  }
</style>
