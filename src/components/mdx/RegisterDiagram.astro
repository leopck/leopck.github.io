---
/**
 * RegisterDiagram Component
 * 
 * Visualizes hardware register bit layouts.
 * 
 * Usage in MDX:
 * <RegisterDiagram
 *   name="RTC_CNTL_CLK_CONF_REG"
 *   address="0x3FF48070"
 *   bits={[
 *     { range: "31:26", name: "Reserved", desc: "Reserved bits" },
 *     { range: "25:24", name: "FAST_CLK_RTC_SEL", desc: "Fast clock source select" },
 *     { range: "23:22", name: "ANA_CLK_RTC_SEL", desc: "Analog clock source" },
 *   ]}
 * />
 */

interface BitField {
  range: string;  // e.g., "31:26" or "0"
  name: string;
  desc?: string;
  value?: string;
  color?: 'blue' | 'green' | 'orange' | 'red' | 'purple' | 'gray';
}

interface Props {
  name: string;
  address?: string;
  bits: BitField[];
  width?: 32 | 64;
}

const { name, address, bits, width = 32 } = Astro.props;

// Parse bit ranges and calculate widths
const parsedBits = bits.map((bit) => {
  const [high, low] = bit.range.includes(':') 
    ? bit.range.split(':').map(Number)
    : [Number(bit.range), Number(bit.range)];
  
  return {
    ...bit,
    high,
    low,
    span: high - low + 1,
  };
});

// Generate bit number labels for top row
const bitNumbers = Array.from({ length: width }, (_, i) => width - 1 - i);
---

<div class="register-diagram">
  <div class="register-header">
    <code class="register-name">{name}</code>
    {address && <code class="register-address">{address}</code>}
  </div>
  
  <!-- Bit number ruler -->
  <div class="bit-ruler" style={`--bits: ${width}`}>
    {bitNumbers.filter((_, i) => i % 4 === 0).map((num) => (
      <span class="bit-number" style={`--pos: ${width - 1 - num}`}>{num}</span>
    ))}
  </div>
  
  <!-- Register visualization -->
  <div class="register-bits" style={`--bits: ${width}`}>
    {parsedBits.map((bit) => (
      <div 
        class:list={['bit-field', `color-${bit.color || 'blue'}`]}
        style={`--start: ${width - 1 - bit.high}; --span: ${bit.span}`}
        title={bit.desc || bit.name}
      >
        <span class="bit-label">{bit.name}</span>
        {bit.value && <span class="bit-value">{bit.value}</span>}
      </div>
    ))}
  </div>
  
  <!-- Legend -->
  <div class="register-legend">
    {parsedBits.map((bit) => (
      <div class="legend-item">
        <span class:list={['legend-color', `color-${bit.color || 'blue'}`]}></span>
        <code class="legend-range">[{bit.range}]</code>
        <span class="legend-name">{bit.name}</span>
        {bit.desc && <span class="legend-desc">{bit.desc}</span>}
      </div>
    ))}
  </div>
</div>

<style lang="scss">
  @use '../../styles/variables' as *;
  
  .register-diagram {
    margin: $space-8 0;
    padding: $space-5;
    background: $color-bg-secondary;
    border: 1px solid $color-border-default;
    border-radius: $border-radius-lg;
    overflow-x: auto;
  }
  
  .register-header {
    display: flex;
    align-items: center;
    gap: $space-4;
    margin-bottom: $space-4;
    padding-bottom: $space-4;
    border-bottom: 1px solid $color-border-default;
  }
  
  .register-name {
    font-family: $font-mono;
    font-size: $font-size-sm;
    font-weight: $font-weight-semibold;
    color: $color-accent-cyan;
    background: transparent;
    padding: 0;
  }
  
  .register-address {
    font-family: $font-mono;
    font-size: $font-size-xs;
    color: $color-text-tertiary;
    background: $color-bg-tertiary;
    padding: $space-1 $space-2;
    border-radius: $border-radius-sm;
  }
  
  .bit-ruler {
    display: grid;
    grid-template-columns: repeat(var(--bits), 1fr);
    margin-bottom: $space-1;
    min-width: 600px;
  }
  
  .bit-number {
    grid-column: calc(var(--pos) + 1);
    font-family: $font-mono;
    font-size: $font-size-xs;
    color: $color-text-tertiary;
    text-align: center;
  }
  
  .register-bits {
    display: grid;
    grid-template-columns: repeat(var(--bits), 1fr);
    gap: 1px;
    min-width: 600px;
    background: $color-border-default;
    border: 1px solid $color-border-default;
    border-radius: $border-radius-sm;
    overflow: hidden;
  }
  
  .bit-field {
    grid-column: calc(var(--start) + 1) / span var(--span);
    padding: $space-2 $space-1;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2px;
    min-height: 48px;
    cursor: help;
    transition: filter $transition-fast;
    
    &:hover {
      filter: brightness(1.2);
    }
    
    // Color variants
    &.color-blue {
      background: rgba($color-accent-blue, 0.2);
      border-left: 2px solid $color-accent-blue;
    }
    
    &.color-green {
      background: rgba($color-accent-green, 0.2);
      border-left: 2px solid $color-accent-green;
    }
    
    &.color-orange {
      background: rgba($color-accent-orange, 0.2);
      border-left: 2px solid $color-accent-orange;
    }
    
    &.color-red {
      background: rgba($color-accent-red, 0.2);
      border-left: 2px solid $color-accent-red;
    }
    
    &.color-purple {
      background: rgba($color-accent-purple, 0.2);
      border-left: 2px solid $color-accent-purple;
    }
    
    &.color-gray {
      background: rgba($color-text-tertiary, 0.1);
      border-left: 2px solid $color-text-tertiary;
    }
  }
  
  .bit-label {
    font-family: $font-mono;
    font-size: $font-size-xs;
    font-weight: $font-weight-medium;
    color: $color-text-primary;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }
  
  .bit-value {
    font-family: $font-mono;
    font-size: 10px;
    color: $color-text-secondary;
  }
  
  .register-legend {
    margin-top: $space-4;
    padding-top: $space-4;
    border-top: 1px solid $color-border-default;
    display: flex;
    flex-direction: column;
    gap: $space-2;
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    gap: $space-2;
    font-size: $font-size-sm;
  }
  
  .legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
    flex-shrink: 0;
    
    &.color-blue { background: $color-accent-blue; }
    &.color-green { background: $color-accent-green; }
    &.color-orange { background: $color-accent-orange; }
    &.color-red { background: $color-accent-red; }
    &.color-purple { background: $color-accent-purple; }
    &.color-gray { background: $color-text-tertiary; }
  }
  
  .legend-range {
    font-family: $font-mono;
    font-size: $font-size-xs;
    color: $color-text-tertiary;
    background: transparent;
    padding: 0;
    min-width: 60px;
  }
  
  .legend-name {
    font-family: $font-mono;
    font-weight: $font-weight-medium;
    color: $color-text-primary;
    min-width: 150px;
  }
  
  .legend-desc {
    color: $color-text-secondary;
  }
</style>
