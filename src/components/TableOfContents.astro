---
interface Props {
  headings: { depth: number; slug: string; text: string }[];
}

const { headings } = Astro.props;

// Filter to only include h2 and h3
const filteredHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);
---

{filteredHeadings.length > 0 && (
  <nav class="toc" aria-label="Table of contents">
    <div class="toc-header">
      <span class="toc-icon">ðŸ“‘</span>
      <span class="toc-title">On this page</span>
    </div>
    <ul class="toc-list">
      {filteredHeadings.map((heading) => (
        <li class:list={['toc-item', `toc-depth-${heading.depth}`]}>
          <a href={`#${heading.slug}`} class="toc-link" data-toc-link>
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
  </nav>
)}

<script>
  // Highlight active TOC item based on scroll position
  const tocLinks = document.querySelectorAll('[data-toc-link]');
  const headings = Array.from(tocLinks).map((link) => {
    const id = link.getAttribute('href')?.slice(1);
    return document.getElementById(id || '');
  }).filter(Boolean);
  
  function updateActiveLink() {
    const scrollPosition = window.scrollY + 100;
    
    let activeIndex = 0;
    headings.forEach((heading, index) => {
      if (heading && heading.offsetTop <= scrollPosition) {
        activeIndex = index;
      }
    });
    
    tocLinks.forEach((link, index) => {
      link.classList.toggle('active', index === activeIndex);
    });
  }
  
  window.addEventListener('scroll', updateActiveLink, { passive: true });
  updateActiveLink();
</script>

<style lang="scss">
  @use '../styles/variables' as *;
  
  .toc {
    font-size: $font-size-sm;
  }
  
  .toc-header {
    display: flex;
    align-items: center;
    gap: $space-2;
    margin-bottom: $space-4;
    padding-bottom: $space-3;
    border-bottom: 1px solid $color-border-default;
  }
  
  .toc-icon {
    font-size: $font-size-base;
  }
  
  .toc-title {
    font-family: $font-mono;
    font-size: $font-size-xs;
    font-weight: $font-weight-semibold;
    text-transform: uppercase;
    letter-spacing: $letter-spacing-wider;
    color: $color-text-tertiary;
  }
  
  .toc-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: $space-1;
  }
  
  .toc-item {
    &.toc-depth-3 {
      padding-left: $space-4;
    }
  }
  
  .toc-link {
    display: block;
    padding: $space-1 $space-2;
    color: $color-text-secondary;
    text-decoration: none;
    border-radius: $border-radius-sm;
    border-left: 2px solid transparent;
    line-height: $line-height-snug;
    transition: all $transition-fast;
    
    &:hover {
      color: $color-text-primary;
      background: $color-bg-tertiary;
    }
    
    &.active {
      color: $color-accent-blue;
      border-left-color: $color-accent-blue;
      background: rgba($color-accent-blue, 0.1);
    }
  }
</style>
