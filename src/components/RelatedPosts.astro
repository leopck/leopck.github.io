---
// RelatedPosts Component
import { getCollection } from 'astro:content';
import PostCard from './PostCard.astro';

interface Props {
  currentSlug: string;
  category: string;
  tags: string[];
}

const { currentSlug, category, tags } = Astro.props;

const allPosts = await getCollection('posts', ({ data }) => !data.draft);

// Score posts by relevance
const scoredPosts = allPosts
  .filter((post) => post.slug !== currentSlug)
  .map((post) => {
    let score = 0;
    
    // Same category = 3 points
    if (post.data.category === category) score += 3;
    
    // Each matching tag = 1 point
    const matchingTags = post.data.tags.filter((tag) => tags.includes(tag));
    score += matchingTags.length;
    
    return { post, score };
  })
  .filter(({ score }) => score > 0)
  .sort((a, b) => b.score - a.score)
  .slice(0, 3);

const relatedPosts = scoredPosts.map(({ post }) => post);
---

{relatedPosts.length > 0 && (
  <section class="related-posts">
    <h2 class="related-posts-title">Related Posts</h2>
    <div class="related-posts-grid">
      {relatedPosts.map((post) => (
        <PostCard post={post} />
      ))}
    </div>
  </section>
)}

<style lang="scss">
  @use '../styles/variables' as *;
  
  .related-posts {
    margin-top: $space-12;
  }
  
  .related-posts-title {
    font-family: $font-display;
    font-size: $font-size-xl;
    margin-bottom: $space-6;
  }
  
  .related-posts-grid {
    display: grid;
    gap: $space-6;
    
    @include respond-to(md) {
      grid-template-columns: repeat(2, 1fr);
    }
    
    @include respond-to(lg) {
      grid-template-columns: repeat(3, 1fr);
    }
  }
</style>
