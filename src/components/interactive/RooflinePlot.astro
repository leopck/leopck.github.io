---
/**
 * Analytical RooflinePlot Component
 * Optimized for stability and professional analysis.
 */

interface Props {
  peakFlops?: number;
  peakBw?: number;
  title?: string;
  initialWork?: number;
  initialTraffic?: number;
  initialTime?: number;
}

const { 
  peakFlops = 312, 
  peakBw = 2039, 
  title = "Performance Analysis Lab",
  initialWork = 1024,
  initialTraffic = 128,
  initialTime = 4.5
} = Astro.props;

const uid = "rf-" + Math.random().toString(36).substring(2, 9);
---

<div class="systems-lab-container my-12" id={uid}>
  <div class="lab-grid">
    <aside class="lab-sidebar">
      <div class="lab-section-header">
        <span>Hardware Parameters</span>
        <span class="version-tag">PROFILER V2.2</span>
      </div>
      
      <div class="lab-scroll-area">
        <div class="lab-field mb-4">
          <label>Architecture Preset</label>
          <select class="h-preset">
            <option value="h100">H100 SXM5 (FP16)</option>
            <option value="a100" selected>A100 80GB (FP16)</option>
            <option value="rtx4090">RTX 4090 (FP16)</option>
            <option value="mi300x">AMD MI300X (FP16)</option>
            <option value="custom">Custom Params</option>
          </select>
        </div>

        <div class="lab-input-grid">
          <div class="lab-field">
            <label>Peak TFLOPS</label>
            <input type="number" class="h-perf" value={peakFlops} />
          </div>
          <div class="lab-field">
            <label>Peak BW (GB/s)</label>
            <input type="number" class="h-bw" value={peakBw} />
          </div>
        </div>

        <div class="lab-field">
          <label>Observed Efficiency (%)</label>
          <input type="range" class="h-eff" min="1" max="100" value="75" />
          <div class="range-labels">
            <span>Practical Ceiling</span>
            <span class="h-eff-val">75%</span>
          </div>
        </div>

        <div class="lab-section-header inner">
          <span>Workload Definition</span>
        </div>
        
        <div class="mode-toggle">
          <button class="mode-btn active" data-mode="manual">Manual</button>
          <button class="mode-btn" data-mode="linear">GEMM</button>
          <button class="mode-btn" data-mode="attn">Attention</button>
        </div>

        <div class="manual-inputs mt-4">
          <div class="lab-input-grid">
            <div class="lab-field">
              <label>Work (GFLOP)</label>
              <input type="number" class="w-work" value={initialWork} />
            </div>
            <div class="lab-field">
              <label>Traffic (GB)</label>
              <input type="number" class="w-traffic" value={initialTraffic} />
            </div>
          </div>
        </div>

        <div class="params-inputs lab-input-grid hidden mt-4">
          <div class="lab-field"><label>Batch (B)</label><input type="number" class="p-b" value="32" /></div>
          <div class="lab-field"><label>Seq (L)</label><input type="number" class="p-l" value="512" /></div>
          <div class="lab-field"><label>Hidden (D)</label><input type="number" class="p-d" value="4096" /></div>
          <div class="lab-field"><label>DType (B)</label><input type="number" class="p-dt" value="2" /></div>
        </div>

        <div class="lab-field mt-4">
          <label>Measured Kernel Time (ms)</label>
          <input type="number" class="w-time" value={initialTime} step="0.001" />
        </div>
      </div>
    </aside>

    <main class="lab-main">
      <div class="lab-chart-frame">
        <canvas class="roofline-canvas"></canvas>
      </div>

      <div class="lab-analytics-grid">
        <div class="lab-card">
          <div class="card-label">Operational Intensity</div>
          <div class="card-value val-intensity" style="color: #539bf5">0.00</div>
          <div class="card-sub">FLOP/Byte</div>
        </div>
        <div class="lab-card">
          <div class="card-label">Throughput SOL</div>
          <div class="card-value val-perf-sol" style="color: #57ab5a">0.0%</div>
          <div class="card-sub val-tflops">0.00 TFLOPS</div>
        </div>
        <div class="lab-card">
          <div class="card-label">Bandwidth SOL</div>
          <div class="card-value val-bw-sol" style="color: #39c5cf">0.0%</div>
          <div class="card-sub val-bw">0.0 GB/s</div>
        </div>
        <div class="lab-card">
          <div class="card-label">Ridge Point</div>
          <div class="card-value val-ridge" style="color: #daaa3f">0.00</div>
          <div class="card-sub">FLOP/B Limit</div>
        </div>
      </div>

      <div class="lab-summary-row">
        <div class="lab-card">
          <div class="card-label">Latency Breakdown (Ideal vs Reality)</div>
          <div class="latency-bar">
            <div class="l-segment bar-comp" style="background: #57ab5a;"></div>
            <div class="l-segment bar-mem" style="background: #39c5cf;"></div>
            <div class="l-segment bar-waste" style="background: #f47067;"></div>
          </div>
          <div class="latency-info mt-3">
             <span class="val-constraint">Analyzing...</span>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script is:inline define:vars={{ uid }}>
(function() {
    const root = document.getElementById(uid);
    if (!root) return;
    const canvas = root.querySelector('.roofline-canvas');
    const ctx = canvas.getContext('2d');
    
    const get = (cls) => root.querySelector(cls);
    
    const ui = {
        hPerf: get('.h-perf'), hBw: get('.h-bw'), hEff: get('.h-eff'), hEffVal: get('.h-eff-val'),
        hPreset: get('.h-preset'), wWork: get('.w-work'), wTraffic: get('.w-traffic'),
        wTime: get('.w-time'), pB: get('.p-b'), pL: get('.p-l'), pD: get('.p-d'), pDT: get('.p-dt'),
        lInt: get('.val-intensity'), lRidge: get('.val-ridge'), lPerfSol: get('.val-perf-sol'),
        lBwSol: get('.val-bw-sol'), lTflops: get('.val-tflops'), lBw: get('.val-bw'),
        lConstraint: get('.val-constraint'), 
        lBarComp: get('.bar-comp'), lBarMem: get('.bar-mem'), lBarWaste: get('.bar-waste')
    };

    let activeMode = 'manual';
    const presets = {
        h100: { p: 1979, b: 3350 }, a100: { p: 312, b: 2039 },
        rtx4090: { p: 82, b: 1008 }, mi300x: { p: 2600, b: 5300 }
    };

    root.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            root.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            activeMode = btn.dataset.mode;
            get('.manual-inputs').classList.toggle('hidden', activeMode !== 'manual');
            get('.params-inputs').classList.toggle('hidden', activeMode === 'manual');
            update();
        });
    });

    function update() {
        if (activeMode === 'linear') {
            const b = parseFloat(ui.pB.value) || 0, l = parseFloat(ui.pL.value) || 0, d = parseFloat(ui.pD.value) || 0, dt = parseFloat(ui.pDT.value) || 0;
            ui.wWork.value = (2 * b * l * d * d) / 1e9;
            ui.wTraffic.value = (d * d * dt + b * l * d * dt * 2) / 1e9;
        } else if (activeMode === 'attn') {
            const b = parseFloat(ui.pB.value) || 0, l = parseFloat(ui.pL.value) || 0, d = parseFloat(ui.pD.value) || 0, dt = parseFloat(ui.pDT.value) || 0;
            ui.wWork.value = (2 * b * l * l * d) / 1e9;
            ui.wTraffic.value = (b * l * d * dt * 3 + b * l * l * dt) / 1e9;
        }

        const pPerf = parseFloat(ui.hPerf.value) || 1;
        const pBw = parseFloat(ui.hBw.value) || 1;
        const eff = (parseFloat(ui.hEff.value) || 0) / 100;
        const work = parseFloat(ui.wWork.value) || 0;
        const traffic = parseFloat(ui.wTraffic.value) || 0.0001; // Avoid div by zero
        const timeMs = parseFloat(ui.wTime.value) || 0.0001;

        const intensity = work / traffic;
        const actualTflops = work / (timeMs / 1000);
        const actualBw = traffic / (timeMs / 1000);
        const ridge = pPerf / (pBw / 1000);

        ui.lInt.textContent = intensity.toFixed(2);
        ui.lRidge.textContent = ridge.toFixed(2);
        ui.lPerfSol.textContent = ((actualTflops / pPerf) * 100).toFixed(1) + "%";
        ui.lBwSol.textContent = ((actualBw / pBw) * 100).toFixed(1) + "%";
        ui.lTflops.textContent = actualTflops.toFixed(2) + " TFLOPS";
        ui.lBw.textContent = actualBw.toFixed(1) + " GB/s";
        ui.hEffVal.textContent = (eff * 100).toFixed(0) + "%";

        const tComp = work / pPerf;
        const tMem = traffic / pBw;
        const total = timeMs / 1000;
        const stall = Math.max(0, total - Math.max(tComp, tMem));
        
        ui.lBarComp.style.width = (tComp / total * 100) + "%";
        ui.lBarMem.style.width = (tMem / total * 100) + "%";
        ui.lBarWaste.style.width = (stall / total * 100) + "%";
        ui.lConstraint.textContent = "Bounded by " + (intensity < ridge ? "Memory Bandwidth" : "Compute Capacity");

        draw(pPerf, pBw, eff, intensity, actualTflops, ridge);
    }

    function draw(pPerf, pBw, eff, curInt, curPerf, ridge) {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        const w = rect.width, h = rect.height, pad = 50;
        const gW = w - pad*2, gH = h - pad*2;
        ctx.clearRect(0,0,w,h);

        const minX = 0.1, maxX = 2048, minY = 0.1, maxY = pPerf * 2;
        const mapX = (v) => pad + (Math.log10(v/minX) / Math.log10(maxX/minX)) * gW;
        const mapY = (v) => (h-pad) - (Math.log10(Math.max(minY, v)/minY) / Math.log10(maxY/minY)) * gH;

        ctx.strokeStyle = '#2d333b'; ctx.lineWidth = 1; ctx.font = '9px monospace'; ctx.fillStyle = '#636e7b';
        [0.1, 1, 10, 100, 1000].forEach(v => {
            const x = mapX(v); ctx.beginPath(); ctx.moveTo(x, pad); ctx.lineTo(x, h-pad); ctx.stroke();
            ctx.fillText(v < 1 ? v.toFixed(1) : v, x - 10, h-pad+15);
        });
        [1, 10, 100, 1000].forEach(v => {
            const y = mapY(v); ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(w-pad, y); ctx.stroke();
            ctx.fillText(v, pad-35, y + 4);
        });

        const ePerf = pPerf * eff; const eBw = pBw * eff;
        const eRidge = ePerf / (eBw/1000);
        ctx.strokeStyle = '#539bf5'; ctx.lineWidth = 3; ctx.beginPath();
        ctx.moveTo(mapX(minX), mapY(Math.max(minY, minX * (eBw/1000))));
        ctx.lineTo(mapX(eRidge), mapY(ePerf));
        ctx.lineTo(mapX(maxX), mapY(ePerf));
        ctx.stroke();

        const dotX = mapX(curInt); const dotY = mapY(curPerf);
        ctx.fillStyle = curInt < ridge ? '#39c5cf' : '#57ab5a';
        ctx.shadowBlur = 15; ctx.shadowColor = ctx.fillStyle;
        ctx.beginPath(); ctx.arc(dotX, dotY, 6, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;

        ctx.fillStyle = '#daaa3f';
        ctx.beginPath(); ctx.arc(mapX(eRidge), mapY(ePerf), 3, 0, Math.PI*2); ctx.fill();
    }

    ui.hPreset.addEventListener('change', (e) => {
        const p = presets[e.target.value];
        if(p) { ui.hPerf.value = p.p; ui.hBw.value = p.b; update(); }
    });

    [ui.hPerf, ui.hBw, ui.hEff, ui.wWork, ui.wTraffic, ui.wTime, ui.pB, ui.pL, ui.pD, ui.pDT].forEach(i => i.addEventListener('input', update));
    window.addEventListener('resize', update);
    update();
})();
</script>

<style lang="scss">
  .systems-lab-container {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border-default);
    border-radius: 12px;
    overflow: hidden;
    color: var(--color-text-primary);
    font-family: var(--font-mono);
  }

  .lab-grid {
    display: grid;
    grid-template-columns: 320px 1fr;
    height: 650px;
    @media (max-width: 1024px) { grid-template-columns: 1fr; height: auto; }
  }

  .lab-sidebar { background: #151921; border-right: 1px solid var(--color-border-default); display: flex; flex-direction: column; }
  .lab-section-header {
    padding: 12px 20px; background: #1c212b; border-bottom: 1px solid var(--color-border-default);
    font-size: 10px; font-weight: bold; display: flex; justify-content: space-between; text-transform: uppercase;
    &.inner { margin-top: 20px; border-top: 1px solid var(--color-border-default); }
  }

  .lab-scroll-area { padding: 20px; overflow-y: auto; flex: 1; }
  .lab-input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .lab-field { display: flex; flex-direction: column; gap: 5px; margin-bottom: 12px; }
  label { font-size: 9px; color: var(--color-text-secondary); text-transform: uppercase; }
  
  input, select {
    background: #0b0e14; border: 1px solid var(--color-border-default); color: #cdd9e5; padding: 6px 10px;
    border-radius: 4px; font-size: 11px; outline: none; &:focus { border-color: var(--color-accent-blue); }
  }

  .mode-toggle {
    display: flex; gap: 5px; margin-top: 10px;
    .mode-btn {
        flex: 1; background: #1c212b; border: 1px solid var(--color-border-default);
        color: var(--color-text-secondary); font-size: 9px; padding: 6px; border-radius: 4px; cursor: pointer;
        &.active { border-color: var(--color-accent-blue); color: white; background: var(--color-accent-blue); }
    }
  }

  .lab-main { padding: 20px; display: flex; flex-direction: column; gap: 20px; background: #0b0e14; overflow-y: auto;}
  .lab-chart-frame { background: #151921; border: 1px solid var(--color-border-default); border-radius: 8px; flex: 1; min-height: 350px; }
  .lab-analytics-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
  .lab-card { background: #151921; border: 1px solid var(--color-border-default); border-radius: 8px; padding: 12px; }
  .card-label { font-size: 8px; text-transform: uppercase; color: var(--color-text-secondary); margin-bottom: 5px; }
  .card-value { font-size: 16px; font-weight: bold; }
  .card-sub { font-size: 9px; color: var(--color-text-tertiary); margin-top: 3px; }

  .latency-bar {
    height: 20px; background: #2d333b; border-radius: 4px; display: flex; overflow: hidden; margin-top: 8px;
    .l-segment { height: 100%; transition: width 0.3s; }
  }

  .hidden { display: none; }
  .range-labels { display: flex; justify-content: space-between; font-size: 8px; margin-top: 4px; color: var(--color-text-tertiary); }
</style>