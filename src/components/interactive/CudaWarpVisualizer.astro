---
title: "CUDA Warp Visualizer"
description: "Interactive visualization of CUDA warp execution and occupancy patterns"
---

<script>
  import { onMount } from 'astro/micro';

  let blockSize = 256;
  let sharedMemPerBlock = 48; // KB
  let registersPerThread = 32;
  let maxBlocksPerSM = 32;
  let warpsPerSM = 64;

  const calculateOccupancy = () => {
    // Calculate based on constraints
    const warpsPerBlock = Math.ceil(blockSize / 32);
    const blocksBySharedMem = Math.floor(64 / (sharedMemPerBlock)); // 64KB per SM
    const blocksByRegs = Math.floor(65536 / (registersPerThread * blockSize)); // 65536 registers per SM
    const blocksByMaxLimit = maxBlocksPerSM;
    
    const theoreticalBlocks = Math.min(blocksBySharedMem, blocksByRegs, blocksByMaxLimit);
    const theoreticalWarps = theoreticalBlocks * warpsPerBlock;
    const achievedWarps = Math.min(theoreticalWarps, warpsPerSM);
    
    const occupancy = (achievedWarps / warpsPerSM) * 100;
    
    return {
      warpsPerBlock,
      theoreticalBlocks,
      achievedWarps,
      occupancy,
      bottleneck: getBottleneck(blocksBySharedMem, blocksByRegs, blocksByMaxLimit)
    };
  };

  const getBottleneck = (sm, rm, ml) => {
    const minVal = Math.min(sm, rm, ml);
    if (minVal === sm) return "Shared Memory";
    if (minVal === rm) return "Registers";
    return "Hardware Limit";
  };

  let result = calculateOccupancy();

  const updateCalculation = () => {
    result = calculateOccupancy();
  };
</script>

<div class="cuda-occupancy-calculator p-6 bg-gray-50 rounded-lg border">
  <h3 class="text-xl font-bold mb-4 text-gray-800">CUDA Occupancy Calculator</h3>
  
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Block Size: {blockSize} threads
        </label>
        <input 
          type="range" 
          min="32" 
          max="1024" 
          step="32"
          value={blockSize}
          onChange={(e) => { blockSize = parseInt(e.target.value); updateCalculation(); }}
          class="w-full"
        />
        <p class="text-xs text-gray-500">Must be multiple of 32 (warp size)</p>
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Shared Mem per Block: {sharedMemPerBlock} KB
        </label>
        <input 
          type="range" 
          min="0" 
          max="96" 
          value={sharedMemPerBlock}
          onChange={(e) => { sharedMemPerBlock = parseInt(e.target.value); updateCalculation(); }}
          class="w-full"
        />
        <p class="text-xs text-gray-500">Shared memory used per thread block</p>
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Registers per Thread: {registersPerThread}
        </label>
        <input 
          type="range" 
          min="8" 
          max="255" 
          value={registersPerThread}
          onChange={(e) => { registersPerThread = parseInt(e.target.value); updateCalculation(); }}
          class="w-full"
        />
        <p class="text-xs text-gray-500">Register usage per thread</p>
      </div>
    </div>
    
    <div class="bg-white p-4 rounded border">
      <h4 class="font-semibold mb-2 text-gray-800">Occupancy Analysis</h4>
      
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-600">Warps per Block:</span>
          <span class="font-mono">{result.warpsPerBlock}</span>
        </div>
        
        <div class="flex justify-between">
          <span class="text-gray-600">Max Theoretical Blocks:</span>
          <span class="font-mono">{result.theoreticalBlocks}</span>
        </div>
        
        <div class="flex justify-between">
          <span class="text-gray-600">Achieved Warps per SM:</span>
          <span class="font-mono">{result.achievedWarps}</span>
        </div>
        
        <div class="border-t pt-2 mt-2">
          <div class="flex justify-between font-semibold text-blue-700">
            <span>Occupancy:</span>
            <span class="text-lg">{result.occupancy.toFixed(1)}%</span>
          </div>
          
          <div class="mt-2 p-2 bg-yellow-50 rounded text-xs">
            <strong>Bottleneck:</strong> {result.bottleneck}
          </div>
        </div>
      </div>
      
      <div class="mt-4 p-3 bg-blue-50 rounded text-xs text-blue-800">
        <strong>Optimization Tip:</strong> Aim for 50-100% occupancy. Consider reducing register usage or adjusting block size to improve occupancy.
      </div>
    </div>
  </div>
  
  <div class="mt-6">
    <h4 class="font-semibold mb-2 text-gray-800">Warp Execution Visualization</h4>
    <div class="flex items-center space-x-1 h-16">
      {Array.from({length: 32}, (_, i) => (
        <div 
          key={i}
          class={`w-6 h-8 border ${
            i < (blockSize > 0 ? blockSize / 8 : 0) % 32 ? 'bg-blue-500 text-white' : 'bg-gray-200'
          } flex items-center justify-center text-xs border-gray-400`}
        >
          {i < blockSize / 32 ? i % 32 : ''}
        </div>
      ))}
    </div>
    <p class="text-xs text-gray-600 mt-1">Each column represents 4 threads in a warp. Active threads shown in blue.</p>
  </div>
</div>

<style>
  .cuda-occupancy-calculator {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }
  
  input[type="range"] {
    height: 6px;
    border-radius: 3px;
    background: #e5e7eb;
    outline: none;
  }
  
  input[type="range"]::-webkit-slider-thumb {
    appearance: none;
    height: 18px;
    width: 18px;
    border-radius: 50%;
    background: #3b82f6;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  
  input[type="range"]::-moz-range-thumb {
    height: 18px;
    width: 18px;
    border-radius: 50%;
    background: #3b82f6;
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
</style>