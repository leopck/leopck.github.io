---
import BaseLayout from '@/layouts/BaseLayout.astro';
import PostCard from '@/components/PostCard.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => !data.draft);
  const categories = [...new Set(posts.map((p) => p.data.category))];
  
  return categories.map((category) => ({
    params: { category },
    props: {
      category,
      posts: posts.filter((p) => p.data.category === category),
    },
  }));
}

const { category, posts } = Astro.props;

const sortedPosts = posts.sort((a, b) => 
  b.data.publishDate.valueOf() - a.data.publishDate.valueOf()
);

const categoryMeta: Record<string, { name: string; icon: string; description: string }> = {
  'microcontrollers': {
    name: 'Microcontrollers',
    icon: 'üîå',
    description: 'Bare-metal programming, register-level optimization, and embedded systems deep-dives.',
  },
  'vllm': {
    name: 'vLLM',
    icon: 'üöÄ',
    description: 'vLLM internals, PagedAttention, continuous batching, and inference serving optimization.',
  },
  'llm-inference': {
    name: 'LLM Inference',
    icon: 'üß†',
    description: 'Large language model inference optimization and transformer performance.',
  },
  'transformers': {
    name: 'Transformers',
    icon: 'üîÆ',
    description: 'Attention mechanisms, architecture analysis, and transformer implementation details.',
  },
  'hardware-optimization': {
    name: 'Hardware Optimization',
    icon: '‚öôÔ∏è',
    description: 'CPU/GPU optimization, SIMD, cache hierarchy, and hardware-aware design.',
  },
  'profiling': {
    name: 'Profiling',
    icon: 'üìä',
    description: 'Performance analysis with perf, DTrace, eBPF, and systematic debugging.',
  },
  'kernel-development': {
    name: 'Kernel Development',
    icon: 'üîß',
    description: 'Custom kernel development, CUDA, Triton, and low-level GPU programming.',
  },
  'memory-systems': {
    name: 'Memory Systems',
    icon: 'üíæ',
    description: 'Memory hierarchy optimization, cache behavior, and memory-bound workloads.',
  },
  'distributed-systems': {
    name: 'Distributed Systems',
    icon: 'üåê',
    description: 'Distributed inference, tensor parallelism, and cluster optimization.',
  },
  'gpu-programming': {
    name: 'GPU Programming',
    icon: 'üéÆ',
    description: 'CUDA, Habana Gaudi, GPU architecture, and accelerator programming.',
  },
};

const meta = categoryMeta[category] || { name: category, icon: 'üìÅ', description: '' };
---

<BaseLayout 
  title={meta.name}
  description={meta.description}
>
  <div class="category-page">
    <header class="page-header">
      <div class="container">
        <span class="header-icon">{meta.icon}</span>
        <h1 class="page-title">{meta.name}</h1>
        <p class="page-description">{meta.description}</p>
        <p class="post-count">{sortedPosts.length} articles</p>
      </div>
    </header>
    
    <div class="page-content">
      <div class="container">
        <div class="posts-grid">
          {sortedPosts.map((post) => (
            <PostCard post={post} />
          ))}
        </div>
        
        <div class="page-nav">
          <a href="/categories" class="nav-link">
            ‚Üê All Categories
          </a>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<style lang="scss">
  @use '../../styles/variables' as *;
  
  .page-header {
    padding: $space-16 0 $space-10;
    background: $color-bg-secondary;
    border-bottom: 1px solid $color-border-default;
    text-align: center;
  }
  
  .header-icon {
    font-size: 3rem;
    display: block;
    margin-bottom: $space-4;
  }
  
  .page-title {
    font-size: $font-size-3xl;
    margin-bottom: $space-3;
  }
  
  .page-description {
    font-size: $font-size-lg;
    color: $color-text-secondary;
    max-width: 600px;
    margin: 0 auto $space-4;
  }
  
  .post-count {
    font-family: $font-mono;
    font-size: $font-size-sm;
    color: $color-text-tertiary;
    margin: 0;
  }
  
  .page-content {
    padding: $space-12 0;
  }
  
  .posts-grid {
    display: grid;
    gap: $space-6;
    
    @include respond-to(md) {
      grid-template-columns: repeat(2, 1fr);
    }
    
    @include respond-to(lg) {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  
  .page-nav {
    margin-top: $space-12;
    padding-top: $space-8;
    border-top: 1px solid $color-border-default;
  }
  
  .nav-link {
    font-size: $font-size-sm;
    font-weight: $font-weight-medium;
    color: $color-text-secondary;
    
    &:hover {
      color: $color-accent-blue;
    }
  }
</style>
