---
import BaseLayout from '@/layouts/BaseLayout.astro';
import PostCard from '@/components/PostCard.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('posts', ({ data }) => !data.draft);
const sortedPosts = allPosts.sort((a, b) => 
  b.data.publishDate.valueOf() - a.data.publishDate.valueOf()
);

// Get unique categories and tags
const categories = [...new Set(allPosts.map((p) => p.data.category))];
const allTags = allPosts.flatMap((p) => p.data.tags);
const tagCounts = allTags.reduce((acc, tag) => {
  acc[tag] = (acc[tag] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

const popularTags = Object.entries(tagCounts)
  .sort((a, b) => b[1] - a[1])
  .slice(0, 15)
  .map(([tag]) => tag);
---

<BaseLayout 
  title="All Posts" 
  description="Browse all technical deep-dives on systems performance, from microcontrollers to LLM inference"
>
  <div class="posts-page">
    <header class="page-header">
      <div class="container">
        <h1 class="page-title">All Posts</h1>
        <p class="page-description">
          {sortedPosts.length} articles on systems performance and optimization
        </p>
      </div>
    </header>
    
    <div class="page-content">
      <div class="container">
        <div class="content-layout">
          <!-- Main content -->
          <main class="posts-main">
            <div class="posts-grid">
              {sortedPosts.map((post) => (
                <PostCard post={post} />
              ))}
            </div>
          </main>
          
          <!-- Sidebar -->
          <aside class="posts-sidebar">
            <div class="sidebar-section">
              <h3 class="sidebar-title">Categories</h3>
              <ul class="sidebar-list">
                {categories.map((cat) => (
                  <li>
                    <a href={`/categories/${cat}`} class="sidebar-link">
                      <span class="badge badge-category" data-category={cat}>
                        {cat.replace('-', ' ')}
                      </span>
                      <span class="link-count">
                        {allPosts.filter((p) => p.data.category === cat).length}
                      </span>
                    </a>
                  </li>
                ))}
              </ul>
            </div>
            
            <div class="sidebar-section">
              <h3 class="sidebar-title">Popular Tags</h3>
              <div class="tags-cloud">
                {popularTags.map((tag) => (
                  <a href={`/tags/${tag}`} class="tag-link">
                    #{tag}
                  </a>
                ))}
              </div>
            </div>
          </aside>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<style lang="scss">
  @use '../../styles/variables' as *;
  
  .posts-page {
    min-height: 100vh;
  }
  
  .page-header {
    padding: $space-16 0 $space-10;
    background: $color-bg-secondary;
    border-bottom: 1px solid $color-border-default;
  }
  
  .page-title {
    font-size: $font-size-3xl;
    margin-bottom: $space-3;
  }
  
  .page-description {
    font-size: $font-size-lg;
    color: $color-text-secondary;
    margin: 0;
  }
  
  .page-content {
    padding: $space-12 0;
  }
  
  .content-layout {
    display: grid;
    gap: $space-12;
    
    @include respond-to(xl) {
      grid-template-columns: 1fr 280px;
    }
  }
  
  .posts-main {
    min-width: 0;
  }
  
  .posts-grid {
    display: grid;
    gap: $space-6;
    
    @include respond-to(md) {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  .posts-sidebar {
    display: none;
    
    @include respond-to(xl) {
      display: block;
    }
  }
  
  .sidebar-section {
    margin-bottom: $space-8;
    padding: $space-5;
    background: $color-bg-secondary;
    border: 1px solid $color-border-default;
    border-radius: $border-radius-lg;
  }
  
  .sidebar-title {
    font-family: $font-mono;
    font-size: $font-size-xs;
    font-weight: $font-weight-semibold;
    text-transform: uppercase;
    letter-spacing: $letter-spacing-wider;
    color: $color-text-tertiary;
    margin: 0 0 $space-4;
    padding-bottom: $space-3;
    border-bottom: 1px solid $color-border-default;
  }
  
  .sidebar-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: $space-2;
  }
  
  .sidebar-link {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: $space-2;
    border-radius: $border-radius-md;
    text-decoration: none;
    transition: background $transition-fast;
    
    &:hover {
      background: $color-bg-tertiary;
      text-decoration: none;
    }
  }
  
  .link-count {
    font-family: $font-mono;
    font-size: $font-size-xs;
    color: $color-text-tertiary;
  }
  
  .tags-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: $space-2;
  }
  
  .tag-link {
    display: inline-block;
    padding: $space-1 $space-2;
    font-family: $font-mono;
    font-size: $font-size-xs;
    color: $color-text-secondary;
    background: $color-bg-tertiary;
    border-radius: $border-radius-full;
    text-decoration: none;
    transition: all $transition-fast;
    
    &:hover {
      color: $color-accent-blue;
      background: rgba($color-accent-blue, 0.1);
      text-decoration: none;
    }
  }
</style>
