---
import BaseLayout from './BaseLayout.astro';
import TableOfContents from '@/components/TableOfContents.astro';
import PostMeta from '@/components/PostMeta.astro';
import RelatedPosts from '@/components/RelatedPosts.astro';
import AuthorBio from '@/components/AuthorBio.astro';
import SeriesNav from '@/components/SeriesNav.astro';
import type { CollectionEntry } from 'astro:content';

interface Props {
  post: CollectionEntry<'posts'>;
  headings: { depth: number; slug: string; text: string }[];
}

const { post, headings } = Astro.props;
const { title, description, publishDate, updatedDate, author, category, tags, difficulty, readingTime, series, seriesOrder, prerequisites, heroImage } = post.data;

// Calculate reading time if not provided
const calculatedReadingTime = readingTime || Math.ceil(post.body.split(/\s+/).length / 200);
---

<BaseLayout 
  title={title} 
  description={description} 
  type="article" 
  publishDate={publishDate}
  author={author}
  image={heroImage}
>
  <article class="post">
    <!-- Hero Section -->
    <header class="post-header">
      <div class="container">
        <div class="post-category">
          <span class="badge badge-category" data-category={category}>
            {category.replace('-', ' ')}
          </span>
          <span class="badge badge-difficulty" data-difficulty={difficulty}>
            {difficulty}
          </span>
        </div>
        
        <h1 class="post-title">{title}</h1>
        
        <p class="post-description">{description}</p>
        
        <PostMeta 
          publishDate={publishDate}
          updatedDate={updatedDate}
          author={author}
          readingTime={calculatedReadingTime}
          tags={tags}
        />
        
        {prerequisites && prerequisites.length > 0 && (
          <div class="post-prerequisites">
            <span class="prerequisites-label">Prerequisites:</span>
            <ul class="prerequisites-list">
              {prerequisites.map((prereq) => (
                <li>{prereq}</li>
              ))}
            </ul>
          </div>
        )}
      </div>
    </header>
    
    <!-- Main Content Area -->
    <div class="post-content-wrapper">
      <div class="container">
        <div class="post-layout">
          <!-- Table of Contents Sidebar -->
          {headings.length > 2 && (
            <aside class="post-sidebar">
              <TableOfContents headings={headings} />
            </aside>
          )}
          
          <!-- Article Content -->
          <div class="post-content prose">
            {series && seriesOrder && (
              <SeriesNav series={series} currentOrder={seriesOrder} />
            )}
            
            <slot />
            
            <!-- Tags Footer -->
            <footer class="post-footer">
              <div class="post-tags">
                {tags.map((tag) => (
                  <a href={`/tags/${tag}`} class="tag">
                    #{tag}
                  </a>
                ))}
              </div>
            </footer>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Author & Related Posts -->
    <section class="post-additional">
      <div class="container">
        <AuthorBio author={author} />
        <RelatedPosts 
          currentSlug={post.slug} 
          category={category} 
          tags={tags} 
        />
      </div>
    </section>
  </article>
</BaseLayout>

<style lang="scss">
  @use '../styles/variables' as *;
  
  .post-header {
    padding: $space-16 0 $space-12;
    background: linear-gradient(
      180deg,
      $color-bg-secondary 0%,
      $color-bg-primary 100%
    );
    border-bottom: 1px solid $color-border-default;
    
    .container {
      max-width: $content-max-width;
    }
  }
  
  .post-category {
    display: flex;
    gap: $space-2;
    margin-bottom: $space-4;
  }
  
  .post-title {
    font-size: $font-size-3xl;
    line-height: $line-height-tight;
    margin-bottom: $space-4;
    
    @include respond-to(lg) {
      font-size: $font-size-4xl;
    }
  }
  
  .post-description {
    font-size: $font-size-lg;
    color: $color-text-secondary;
    line-height: $line-height-relaxed;
    margin-bottom: $space-6;
    max-width: 65ch;
  }
  
  .post-prerequisites {
    margin-top: $space-6;
    padding: $space-4;
    background: $color-bg-tertiary;
    border-radius: $border-radius-md;
    border-left: 3px solid $color-accent-orange;
    
    .prerequisites-label {
      display: block;
      font-size: $font-size-sm;
      font-weight: $font-weight-semibold;
      color: $color-accent-orange;
      margin-bottom: $space-2;
    }
    
    .prerequisites-list {
      margin: 0;
      padding-left: $space-5;
      font-size: $font-size-sm;
      color: $color-text-secondary;
      
      li {
        margin-bottom: $space-1;
      }
    }
  }
  
  .post-content-wrapper {
    padding: $space-12 0;
  }
  
  .post-layout {
    display: grid;
    gap: $space-12;
    
    @include respond-to(xl) {
      grid-template-columns: 1fr 260px;
    }
  }
  
  .post-sidebar {
    display: none;
    
    @include respond-to(xl) {
      display: block;
      order: 2;
      position: sticky;
      top: calc($header-height + $space-8);
      height: fit-content;
      max-height: calc(100vh - $header-height - $space-16);
      overflow-y: auto;
      @include scrollbar-thin;
    }
  }
  
  .post-content {
    min-width: 0;
    max-width: $content-max-width;
    
    @include respond-to(xl) {
      order: 1;
    }
    
    // Enhanced prose styling
    :global(h2) {
      margin-top: $space-12;
      margin-bottom: $space-4;
      padding-bottom: $space-2;
      border-bottom: 1px solid $color-border-default;
      
      &:first-child {
        margin-top: 0;
      }
    }
    
    :global(h3) {
      margin-top: $space-8;
      margin-bottom: $space-3;
    }
    
    :global(h4) {
      margin-top: $space-6;
      margin-bottom: $space-2;
    }
    
    // Anchor links on headings
    :global(h2, h3, h4, h5, h6) {
      position: relative;
      
      &:hover :global(.anchor-link) {
        opacity: 1;
      }
    }
    
    :global(.anchor-link) {
      position: absolute;
      left: -1.5em;
      opacity: 0;
      color: $color-text-tertiary;
      text-decoration: none;
      transition: opacity $transition-fast;
      
      &:hover {
        color: $color-accent-blue;
      }
    }
    
    // Code blocks with enhanced styling
    :global(pre) {
      margin: $space-6 0;
    }
    
    // Custom component containers
    :global(.perf-chart-container),
    :global(.register-diagram),
    :global(.memory-layout-diagram),
    :global(.benchmark-results) {
      margin: $space-8 0;
      padding: $space-6;
      background: $color-bg-secondary;
      border: 1px solid $color-border-default;
      border-radius: $border-radius-lg;
    }
    
    // Inline annotations
    :global([data-perf-annotation]) {
      position: relative;
      background: rgba($color-accent-orange, 0.1);
      padding: 0 $space-1;
      border-radius: $border-radius-sm;
      cursor: help;
      
      &::after {
        content: attr(data-perf-value);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        padding: $space-1 $space-2;
        background: $color-bg-elevated;
        border: 1px solid $color-border-default;
        border-radius: $border-radius-sm;
        font-size: $font-size-xs;
        font-family: $font-mono;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity $transition-fast;
      }
      
      &:hover::after {
        opacity: 1;
      }
    }
  }
  
  .post-footer {
    margin-top: $space-12;
    padding-top: $space-8;
    border-top: 1px solid $color-border-default;
  }
  
  .post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: $space-2;
  }
  
  .tag {
    display: inline-block;
    padding: $space-1 $space-3;
    font-size: $font-size-sm;
    font-family: $font-mono;
    color: $color-text-secondary;
    background: $color-bg-tertiary;
    border-radius: $border-radius-full;
    transition: all $transition-fast;
    
    &:hover {
      color: $color-accent-blue;
      background: rgba($color-accent-blue, 0.1);
      text-decoration: none;
    }
  }
  
  .post-additional {
    padding: $space-16 0;
    background: $color-bg-secondary;
    border-top: 1px solid $color-border-default;
    
    .container {
      max-width: $content-max-width;
    }
  }
</style>
