---
title: "ESP32 CPU Frequency Scaling: Dynamic Performance and Power Optimization"
author: "stanley-phoong"
description: "Comprehensive guide to ESP32 CPU frequency scaling, optimizing performance vs power trade-offs, and implementing dynamic frequency adjustment."
publishDate: 2019-12-31
category: microcontrollers
tags: [esp32, cpu, frequency-scaling, power, optimization, performance]
difficulty: advanced
readingTime: 18
---

import Callout from '@/components/mdx/Callout.astro';
import PerfChart from '@/components/mdx/PerfChart.astro';
import Benchmark from '@/components/mdx/Benchmark.astro';

ESP32 supports dynamic CPU frequency scaling. Optimizing frequency selection balances performance and power consumption.

## ESP32 Frequency Options

ESP32 supports multiple CPU frequencies:

<Benchmark
  title="ESP32 CPU Frequency Options"
  columns={["Frequency", "Current (mA)", "Performance", "Use Case"]}
  rows={[
    { values: ["80 MHz", "~50", "Low", "Idle/Low power"], highlight: false },
    { values: ["160 MHz", "~75", "Medium", "Balanced"], highlight: true },
    { values: ["240 MHz", "~100", "High", "Maximum performance"], highlight: true },
  ]}
/>

## Dynamic Frequency Scaling

Adjust frequency based on workload:

```cpp
#include "esp_pm.h"
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"

void configure_dynamic_frequency(void) {
    // Configure power management
    esp_pm_config_esp32_t pm_config = {
        .max_freq_mhz = 240,      // Maximum frequency
        .min_freq_mhz = 80,       // Minimum frequency
        .light_sleep_enable = true // Enable light sleep
    };
    
    esp_pm_configure(&pm_config);
}

void set_cpu_frequency(uint32_t freq_mhz) {
    // Set CPU frequency
    setCpuFrequencyMhz(freq_mhz);
    
    Serial.printf("CPU frequency set to: %lu MHz\n", freq_mhz);
    Serial.printf("Actual frequency: %lu MHz\n", getCpuFrequencyMhz());
}
```

## Performance vs Power Analysis

Frequency impact on performance and power:

<PerfChart
  title="Performance vs Power Trade-off"
  type="scatter"
  data={{
    datasets: [
      {
        label: "80 MHz",
        data: [{x: 50, y: 80}],
        backgroundColor: "#10b981",
      },
      {
        label: "160 MHz",
        data: [{x: 75, y: 160}],
        backgroundColor: "#3b82f6",
      },
      {
        label: "240 MHz",
        data: [{x: 100, y: 240}],
        backgroundColor: "#ef4444",
      }
    ]
  }}
/>

## Adaptive Frequency Control

Adjust frequency based on task requirements:

```cpp
void adaptive_frequency_control(void) {
    // Measure task execution time
    unsigned long start_time = micros();
    
    // Perform task
    process_sensor_data();
    
    unsigned long execution_time = micros() - start_time;
    
    // Adjust frequency based on timing
    if (execution_time > 10000) {  // > 10 ms
        // Task is slow, increase frequency
        setCpuFrequencyMhz(240);
    } else if (execution_time < 1000) {  // < 1 ms
        // Task is fast, can reduce frequency
        setCpuFrequencyMhz(80);
    } else {
        // Balanced frequency
        setCpuFrequencyMhz(160);
    }
}
```

## Power Management Integration

Integrate with power management:

```cpp
void power_aware_frequency_scaling(void) {
    // Check battery level
    float battery_voltage = read_battery_voltage();
    
    if (battery_voltage > 3.7) {
        // High battery: use maximum frequency
        setCpuFrequencyMhz(240);
    } else if (battery_voltage > 3.3) {
        // Medium battery: balanced frequency
        setCpuFrequencyMhz(160);
    } else {
        // Low battery: minimum frequency
        setCpuFrequencyMhz(80);
    }
}
```

## Real-Time Constraints

Meet real-time deadlines:

```cpp
void real_time_frequency_control(void) {
    // Task must complete in 5 ms
    uint32_t deadline_us = 5000;
    
    // Start at low frequency
    setCpuFrequencyMhz(80);
    
    unsigned long start = micros();
    process_task();
    unsigned long elapsed = micros() - start;
    
    if (elapsed > deadline_us) {
        // Increase frequency to meet deadline
        setCpuFrequencyMhz(240);
        process_task();  // Retry at higher frequency
    }
}
```

## Energy Efficiency

Optimize for energy per task:

<Benchmark
  title="Energy per Task vs Frequency"
  columns={["Frequency", "Power (mW)", "Time (ms)", "Energy (µJ)"]}
  rows={[
    { values: ["80 MHz", "165", "12.5", "2.06"], highlight: false },
    { values: ["160 MHz", "247", "6.25", "1.54"], highlight: true },
    { values: ["240 MHz", "330", "4.17", "1.38"], highlight: true },
  ]}
/>

<Callout type="tip" title="Energy Optimization">
  Higher frequency completes tasks faster, potentially saving total energy despite higher power consumption.
</Callout>

## Frequency Switching Overhead

Measure switching overhead:

```cpp
void measure_frequency_switch_overhead(void) {
    unsigned long start, end;
    
    // Measure switch time
    start = micros();
    setCpuFrequencyMhz(240);
    end = micros();
    
    Serial.printf("Switch to 240 MHz: %lu µs\n", end - start);
    
    start = micros();
    setCpuFrequencyMhz(80);
    end = micros();
    
    Serial.printf("Switch to 80 MHz: %lu µs\n", end - start);
}
```

**Overhead**: ~50-200 µs per frequency switch

## Optimization Strategies

1. **Use maximum frequency** for compute-intensive tasks
2. **Reduce frequency** during idle periods
3. **Adapt to workload** based on execution time
4. **Consider battery level** for power-aware scaling
5. **Minimize switches** to reduce overhead

## Conclusion

CPU frequency scaling optimization:

1. **Performance scaling**: Linear with frequency
2. **Power scaling**: Sub-linear (better efficiency at higher freq)
3. **Energy optimization**: Higher frequency can save energy
4. **Real-time constraints**: Adjust frequency to meet deadlines
5. **Adaptive control**: Match frequency to workload

Key strategies:
- Use maximum frequency for performance-critical tasks
- Reduce frequency during idle
- Adapt frequency to workload
- Consider battery level
- Minimize frequency switches

Optimize frequency scaling to balance performance and power consumption.
